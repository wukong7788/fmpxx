## 产品需求文档：AI 财务数据代理

**版本：** 1.0
**日期：** 2025年7月19日星期六

---

### 1. 引言

本文档概述了 AI 代理的需求，该代理将作为 `fmpxx` Python 库的自然语言接口。该代理的主要目的是让用户通过简单的自然语言提问来检索金融市场数据和公司基本面信息，而无需编写代码或理解库的 API 结构。

**1.1. 目的**
目标是创建一个直观高效的方式，让用户能够访问 `fmpxx` 库提供的金融数据，利用 AI 的能力解释用户意图并自动化函数调用。

**1.2. 范围**
本 PRD 侧重于 AI 代理理解自然语言查询并将其映射到 `fmpxx/stocks.py` 和 `fmpxx/financials.py` 中可用函数的能力。它涵盖了核心交互流程、功能能力和高层技术考量。

**1.3. 目标受众**
*   需要快速访问数据的金融分析师和研究人员。
*   寻求金融 API 自然语言接口的开发人员。
*   对股票价格、公司财务和市场趋势感兴趣的普通用户。

---

### 2. 目标

*   **G1: 增强可访问性：** 使 `fmpxx` 库中的金融数据检索对没有编程知识的用户也易于访问。
*   **G2: 自动化数据检索：** 自动将自然语言查询转换为对 `fmpxx` 库的可执行函数调用。
*   **G3: 提供相关响应：** 针对用户查询提供准确且格式良好的金融数据。
*   **G4: 改善用户体验：** 提供一种会话式和直观的方式与金融数据进行交互。

---

### 3. 用户故事 / 用例

以下是用户可能与 AI 代理交互的示例：

*   **US1: 获取损益表：** “作为用户，我希望获取苹果公司上个季度的损益表，以便分析其近期业绩。”
    *   *映射：* `client.financials.get_financials(symbol='AAPL', statement='income', period='quarter', limit=1)`
*   **US2: 获取历史股票价格：** “作为用户，我希望查看谷歌公司过去 5 年的历史股票价格，以便追踪其趋势。”
    *   *映射：* `client.stocks.historical_price_full(symbol='GOOG', period=5)`
*   **US3: 获取当前股票报价：** “作为用户，我希望知道微软的当前报价。”
    *   *映射：* `client.stocks.quote(symbol='MSFT')`
*   **US4: 搜索公司：** “作为用户，我希望在纳斯达克交易所搜索与‘特斯拉’相关的公司。”
    *   *映射：* `client.stocks.search(query='Tesla', exchange='NASDAQ')`
*   **US5: 获取合并财务报表：** “作为用户，我希望获取亚马逊的合并财务报表。”
    *   *映射：* `client.financials.get_merged_financials(symbol='AMZN')`
*   **US6: 获取指定范围的每日价格：** “作为用户，我需要 IBM 从 2023-01-01 到 2023-01-31 的每日价格。”
    *   *映射：* `client.stocks.daily_prices(symbol='IBM', start='2023-01-01', end='2023-01-31')`

---

### 4. 功能需求

**4.1. 自然语言理解 (NLU)**
*   **FR1.1:** 代理应准确解释用户查询，以识别用户意图（例如，“获取损益表”、“获取历史价格”、“搜索公司”）。
*   **FR1.2:** 代理应从用户查询中提取相关实体（例如，公司代码如“Apple”、“GOOG”；日期范围如“上个季度”、“过去 5 年”、“从 2023-01-01 到 2023-01-31”；报表类型如“income”、“balance”；限制如“1”、“5”；交易所名称如“NASDAQ”）。

**4.2. 函数映射与执行**
*   **FR2.1:** 代理应将识别出的意图映射到 `fmpxx/stocks.py` 和 `fmpxx/financials.py` 中相应的 Python 函数。
*   **FR2.2:** 代理应将提取的实体正确地作为参数传递给映射的函数。
*   **FR2.3:** 当缺少强制参数时，代理应通过提示用户提供所需信息来处理。
*   **FR2.4:** 代理应验证提取的参数值（例如，检查有效的股票代码、正确的日期格式、适当的数字限制）。
*   **FR2.5:** 代理应使用 `fmpxx` 库执行识别出的 Python 函数。

**4.3. 响应生成**
*   **FR3.1:** 代理应以清晰、简洁和用户友好的格式呈现函数调用的结果。
*   **FR3.2:** 对于 Pandas DataFrame，代理应应用适当的显示格式（例如，完整列显示、正确对齐）以增强可读性。
*   **FR3.3:** 当给定查询未找到数据时，代理应提供信息性消息。

**4.4. 错误处理**
*   **FR4.1:** 代理应优雅地处理来自 `fmpxx` 库的错误（例如，`InvalidAPIKeyError`、`SymbolNotFoundError`、`RateLimitExceededError`、`FMPConnectionError`）。
*   **FR4.2:** 代理应为错误提供用户友好的解释，并在可能的情况下建议纠正措施（例如，“API 密钥无效，请检查您的配置”、“未找到代码，请验证股票代码”、“超出速率限制，请稍候重试”）。
*   **FR4.3:** 代理应处理意外错误并提供通用的回退消息。

---

### 5. 非功能需求

*   **NFR1: 性能：** 代理应在 5 秒内响应大多数查询，复杂查询不超过 15 秒。
*   **NFR2: 可靠性：** 代理应始终为有效查询提供正确响应，意图识别和参数提取的准确率目标为 95%。
*   **NFR3: 可用性：** 代理的会话界面应直观，新用户学习曲线最小。
*   **NFR4: 可伸缩性：** 底层基础设施应能够处理不断增长的并发用户查询。
*   **NFR5: 安全性：** FMP API 密钥必须安全处理（例如，通过环境变量或秘密管理系统），绝不能直接暴露给用户或在日志中。

---

### 6. 技术设计 (高层)

**6.1. 核心 AI 组件**
*   将使用具有函数调用能力的大型语言模型 (LLM)（例如，Gemini 的函数调用、OpenAI 的函数调用）作为代理的大脑。

**6.2. 工具集成**
*   LLM 将获得与 `fmpxx/stocks.py` 和 `fmpxx/financials.py` 中函数对应的“工具定义”。这些定义将包括函数名称、描述和参数模式（类型、可选性）。

**6.3. 执行环境**
*   代理将在安装了 `fmpxx` 库及其依赖项的 Python 环境中运行。
*   LLM 将生成函数调用，然后这些函数调用将在该 Python 环境中执行。

**6.4. API 密钥管理**
*   FMP API 密钥将在运行时安全加载（例如，从环境变量中）并传递给 `FMPClient` 实例。

---

### 7. 成功指标

*   **函数调用准确性：** 导致正确 `fmpxx` 函数被正确参数调用的用户查询百分比。
*   **用户满意度：** 通过定性反馈或简单的评分系统衡量。
*   **平均响应时间：** 跟踪代理处理查询并返回响应的平均时间。
*   **错误率：** 监控未处理错误或不正确响应的频率。

---